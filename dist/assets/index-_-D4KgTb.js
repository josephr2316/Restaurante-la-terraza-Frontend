(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}})();const o=e=>document.querySelector(e),$="https://restaurante-la-terraza-production.up.railway.app",T="test",a={seedBtn:o("#seed-btn"),refreshAll:o("#refresh-all"),authToken:o("#auth-token"),saveToken:o("#save-token"),seedStatus:o("#seed-status"),serverStatus:o("#server-status"),clock:o("#clock"),toast:o("#toast"),availabilityForm:o("#availability-form"),availabilityResult:o("#availability-result"),reservationForm:o("#reservation-form"),reservationResult:o("#reservation-result"),listForm:o("#list-form"),reservationsContainer:o("#reservations-container"),addTableForm:o("#add-table-form"),areaSelect:o("#area-select"),adminResult:o("#admin-result"),areasList:o("#areas-list"),tablesList:o("#tables-list"),metricAreas:o("#metric-areas"),metricTables:o("#metric-tables"),metricReservations:o("#metric-reservations"),metricPending:o("#metric-pending")},C={PENDING:["CONFIRMED","CANCELLED","EXPIRED"],CONFIRMED:["COMPLETED","CANCELLED","NOSHOW"],CANCELLED:[],NOSHOW:[],COMPLETED:[],EXPIRED:[]},l={areas:[],tables:[],reservations:[],lastAvailability:null};function c(e,t="ok"){a.toast.textContent=e,a.toast.className=`toast show ${t}`,clearTimeout(c.timer),c.timer=setTimeout(()=>{a.toast.className="toast"},2400)}function v(e,t,r){e.textContent=t,e.className=r?"chip chip-ok":"chip chip-err"}function S(e){return JSON.stringify(e,null,2)}function E(){return localStorage.getItem("lt_auth_token")||T}async function d(e,t={}){const r=e.startsWith("http")?e:`${$}${e}`,s={Authorization:`Bearer ${E()}`},i=await fetch(r,{headers:{"Content-Type":"application/json",...s,...t.headers||{}},...t}),u=await i.text(),g=u?JSON.parse(u):null;if(!i.ok)throw new Error(g?.message||`Error ${i.status}`);return g}function L(){return new Date().toISOString().slice(0,10)}function y(){const e=new Date;a.clock.textContent=e.toLocaleTimeString("es-DO",{hour12:!1})}function N(){const e=L();for(const n of[a.availabilityForm,a.reservationForm,a.listForm]){const s=n.querySelector('input[name="date"]');s&&!s.value&&(s.value=e)}const t=a.availabilityForm.querySelector('input[name="startTime"]'),r=a.reservationForm.querySelector('input[name="startTime"]');t.value||(t.value="20:00"),r.value||(r.value="20:00")}function p(){a.metricAreas.textContent=String(l.areas.length),a.metricTables.textContent=String(l.tables.length),a.metricReservations.textContent=String(l.reservations.length),a.metricPending.textContent=String(l.reservations.filter(e=>e.status==="PENDING").length)}function b(){a.areasList.innerHTML=l.areas.length?l.areas.map(e=>`<li><strong>${e.code}</strong> - ${e.name}<br>${e.id} | max ${e.maxTables}</li>`).join(""):"<li>Sin areas.</li>",a.tablesList.innerHTML=l.tables.length?l.tables.map(e=>`<li><strong>${e.code}</strong> cap ${e.capacity}<br>${e.id} | ${e.tableType}</li>`).join(""):"<li>Sin mesas.</li>",a.areaSelect.innerHTML=l.areas.length?l.areas.map(e=>`<option value="${e.id}">${e.code} (${e.name})</option>`).join(""):'<option value="">Sin areas</option>'}function w(e,t,r){const n=r.tableIds?.[0]||"";return`<button class="mini" data-action="send-to-reservation" data-date="${e.date}" data-time="${e.startTime}" data-party="${e.partySize}" data-duration="${e.durationMin}" data-area="${t}" data-table="${n}">Enviar a reserva (${r.capacity}p)</button>`}function k(e){l.lastAvailability=e;const t=e.options.map(r=>{const n=r.feasible?'<span class="tag tag-ok">Disponible</span>':'<span class="tag tag-no">No disponible</span>',s=r.candidates&&r.candidates.length?`<div class="avail-actions">${r.candidates.map(i=>w(e,r.area,i)).join("")}</div>`:"<small>Sin candidatos para este horario.</small>";return`
      <article class="avail-row">
        <div class="avail-head">
          <strong>${r.area}</strong>
          ${n}
        </div>
        ${s}
      </article>
    `}).join("");a.availabilityResult.innerHTML=t||"No hay opciones."}function A(e){const t=a.reservationForm;t.querySelector('input[name="date"]').value=e.date,t.querySelector('input[name="startTime"]').value=e.time,t.querySelector('input[name="partySize"]').value=e.party,t.querySelector('select[name="durationMin"]').value=e.duration,t.querySelector('select[name="areaPreference"]').value=e.area,t.querySelector('input[name="assignedTableId"]').value=e.table||"",c("Reserva autocompletada desde disponibilidad.","ok")}function D(e){const t=C[e.status]||[],r=`
    <select data-role="status" data-id="${e.id}">
      <option value="">Cambiar estado...</option>
      ${t.map(n=>`<option value="${n}">${n}</option>`).join("")}
    </select>
    <button class="mini" data-role="apply-status" data-id="${e.id}" ${t.length?"":"disabled"}>Aplicar</button>
  `;return`
    <article class="rsv">
      <div class="rsv-line">
        <strong>${e.customerName} (${e.partySize}p)</strong>
        <span class="badge ${e.status}">${e.status}</span>
      </div>
      <div>${e.date} ${e.startTime} | Area ${e.areaAssigned} | Mesa ${e.tableAssignedIds.join(", ")}</div>
      <div class="rsv-id">${e.id} | ${e.source}</div>
      <div class="rsv-actions">${r}</div>
    </article>
  `}function R(){if(!l.reservations.length){a.reservationsContainer.innerHTML="<div>No hay reservas para este filtro.</div>";return}a.reservationsContainer.innerHTML=l.reservations.map(e=>D(e)).join("")}async function f(){try{const[e,t,r]=await Promise.all([d("/health"),d("/areas"),d("/tables")]);return v(a.serverStatus,`API: ${e.status} (${new Date(e.time).toLocaleTimeString("es-DO",{hour12:!1})})`,!0),v(a.seedStatus,`Seed: cargado (${t.length} areas, ${r.length} mesas)`,!0),l.areas=t,l.tables=r,b(),p(),!0}catch(e){return v(a.seedStatus,`Seed: pendiente (${e.message})`,!1),l.areas=[],l.tables=[],b(),p(),!1}}async function m(e){e&&e.preventDefault();const t=new FormData(a.listForm),r=new URLSearchParams({date:t.get("date")}),n=String(t.get("areaId")||"").trim();n&&r.set("areaId",n),a.reservationsContainer.textContent="Cargando reservas...";try{l.reservations=await d(`/reservations?${r.toString()}`),R(),p()}catch(s){l.reservations=[],a.reservationsContainer.textContent=`No disponible: ${s.message}`,p()}}async function F(){a.seedBtn.disabled=!0;try{await d("/seed",{method:"POST"}),c("Seed cargado correctamente.","ok")}catch(e){e.message.includes("Already seeded")?c("El seed ya estaba cargado.","ok"):c(`Error de seed: ${e.message}`,"err")}finally{a.seedBtn.disabled=!1}await f(),await m()}async function P(e){e.preventDefault();const t=new FormData(a.availabilityForm),r=new URLSearchParams({date:t.get("date"),startTime:t.get("startTime"),partySize:t.get("partySize"),durationMin:t.get("durationMin"),areaPreference:t.get("areaPreference")});a.availabilityResult.textContent="Consultando...";try{const n=await d(`/availability?${r.toString()}`);k(n)}catch(n){a.availabilityResult.textContent=`Error: ${n.message}`,c(`No se pudo consultar disponibilidad: ${n.message}`,"err")}}function I(){const e=new FormData(a.reservationForm),t={date:e.get("date"),startTime:e.get("startTime"),partySize:Number(e.get("partySize")),durationMin:Number(e.get("durationMin")),areaPreference:e.get("areaPreference"),vipRequested:e.get("vipRequested")==="true",customerName:e.get("customerName"),phone:e.get("phone"),source:e.get("source")},r=["email","notes","occasion","assignedTableId"];for(const n of r){const s=String(e.get(n)||"").trim();s&&(t[n]=s)}return t}async function O(e){e.preventDefault();try{const t=I(),r=await d("/reservations",{method:"POST",body:JSON.stringify(t)});a.reservationResult.textContent=S(r),c("Reserva creada correctamente.","ok");const n=a.listForm.querySelector('input[name="date"]').value;r.date===n&&await m()}catch(t){a.reservationResult.textContent=`Error: ${t.message}`,c(`No se pudo crear la reserva: ${t.message}`,"err")}}async function M(e){e.preventDefault();const t=new FormData(a.addTableForm),r=t.get("areaId"),n={capacity:Number(t.get("capacity")),tableType:t.get("tableType")},s=String(t.get("code")||"").trim();s&&(n.code=s);try{const i=await d(`/areas/${r}/tables`,{method:"POST",body:JSON.stringify(n)});a.adminResult.textContent=S(i),c("Mesa agregada.","ok"),await f()}catch(i){a.adminResult.textContent=`Error: ${i.message}`,c(`No se pudo agregar la mesa: ${i.message}`,"err")}}async function h(e){const t=e.target.closest('button[data-action="send-to-reservation"]');if(t){A(t.dataset);return}const r=e.target.closest('button[data-role="apply-status"]');if(!r)return;const n=r.dataset.id,s=a.reservationsContainer.querySelector(`select[data-role="status"][data-id="${n}"]`),i=s?s.value:"";if(i){r.disabled=!0;try{await d(`/reservations/${n}/status`,{method:"PATCH",body:JSON.stringify({status:i})}),c(`Estado actualizado a ${i}.`,"ok"),await m()}catch(u){c(`No se pudo actualizar estado: ${u.message}`,"err")}finally{r.disabled=!1}}}function x(){a.saveToken.addEventListener("click",()=>{const e=String(a.authToken.value||"").trim();if(!e){localStorage.removeItem("lt_auth_token"),c("Token eliminado. Se usara token por defecto.","ok");return}localStorage.setItem("lt_auth_token",e),c("Token guardado.","ok")}),a.seedBtn.addEventListener("click",F),a.refreshAll.addEventListener("click",async()=>{await f(),await m()}),a.availabilityForm.addEventListener("submit",P),a.reservationForm.addEventListener("submit",O),a.listForm.addEventListener("submit",m),a.addTableForm.addEventListener("submit",M),a.availabilityResult.addEventListener("click",h),a.reservationsContainer.addEventListener("click",h)}async function _(){a.authToken.value=localStorage.getItem("lt_auth_token")||"",y(),setInterval(y,1e3),N(),x(),await f()?await m():(v(a.serverStatus,"API: disponible, falta seed",!1),a.reservationsContainer.textContent="Cargar seed para operar.")}_();
